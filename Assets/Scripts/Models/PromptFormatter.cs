using UnityEngine;
using Cysharp.Threading.Tasks;  // UniTask
using System;

public class PromptFormatter
{
    private string _cardTitle;
    private string _cardExplanation;
    
    private GeminiCardGenerator _geminiCardGenerator;
    
    private string _geminiPrompt => $@"
        以下の写真に写っている人またはペットの特徴を読み取り、カードゲームのパラメータとして「頭脳」「運動」「運」の3つの数値をそれぞれ1から100の範囲で評価してください。三つのパラメータの合計値は100とし、各数値は整数でお願いします。
        また、各パラメータに対して一言（12文字以内）で攻撃の名前を付けてください。クスっと笑ってしまうような攻撃の名前だと嬉しいです。
        最後に、そのキャラクターに合う1、2文（25文字以上35文字以内）の短いフレーバーテキストも作成してください。

        漢字を用いる際は、以下の漢字リストの中に入っている漢字を用いて下さい。

        漢字リスト = [一丁七万丈三上下不与世丘両並中丸丹主乃久之乏乗乙九也乱乳乾亀了予争事二云互五井亜亡交享京亭亮人仁今介仏仕他付仙代令以仮仰仲件任企伊伎伏伐休会伝伯伴伸伺似位低住佐体何余作佳併使例侍供依価侵便係促俊俗保信修俳俵俺倉個倍倒候借値倫偉偏停健側偵偶偽傍傑傘備催債傷傾働像僕僚僧儀億償優儲元兄充兆先光克免児党入全八公六共兵具典兼内円冊再冒冗写冠冬冷凄凍凝凡処凶出刀刃分切刈刊刑列初判別利到制刷券刺刻則削前剛剝剣剤副剰割創劇力功加劣助努励労効勇勉動勘務勝募勢勤勧匂包化北匠匹区医十千午半卑卒卓協南単博占印危即却卵厄厚原厳去参又及友双反収叔取受口古句叩叫召可台史右叶号司各合吉吊同名后吐向君吞否含吸吹吾呂呆告呑呟周呪味呼命和咲咳哀品哉員哲唆唇唐唯唱唾商問啓善喉喋喚喜喧喩喪喫喰営嗅嘆嘉嘘嘩噂噌噓器噴嚙囁囚四回因団困囲図固国國圏園土圧在圭地坂均坊坐垂型垣埋城埜域執培基埼堀堂堅堤堪報場塁塊塔塗塚塞塩塾境墓増墜墨墳壁壇壊士壮声売変夏夕外多夜夢大天太夫央失夷奇奈奉奏契奥奨奪奮女奴好如妃妄妊妖妙妥妨妹妻姉始姓委姫姿威娘娠婆婚婦媒嫁嫌嬉嬢子孔字存孝季孤学孫宅宇守安完宏宗官宙定宛宝実客宣室宮宰害宴家容宿寂寄密富寒寛寝察寧審寮寸寺対寿封専射将尉尊尋導小少尖尚就尻尽尾尿局居屈届屋展属層履山岐岡岩岳岸峰島崇崎崖崩嵐嶋川州巡巣工左巧巨差己巻市布帆希帝師席帯帰帳常帽幅幌幕幣干平年幸幹幻幼幽幾庁広床序底店府度座庫庭庶康廃廊延廷建弁式弓引弘弟弥弦弱張強弾当形彦彩彫彰影役彼往征径待律後徐徒従得從御復循微徳徴徹心必忌忍志忘忙応忠快念怒怖思怠急性怪怯恋恐恒恥恨恩恭息恵悔悟悠患悩悪悲情惑惚惜惨想惹愉意愚愛感慈態慌慎慢慣慮慰慶憂憎憑憤憧憩憲憶懐懲懸成我戒戚戦戯戸戻房所扇扉手才打払扱批承技抄把抑投抗折抜択披抱抵押抽担拉拍拒拓拘拙招拝拠拡括拭拳拶拾持指挑挙挟挨振挿捉捕捜捨据掃授掌排掘掛採探接控推措掲揃揉描提揚換握揮援揺損搔搬携摂摑摘摩撃撤撫撮撲擁操擦支改攻放政故敏救敗教敢散敬数整敵敷文斉斎斐料斜斧斬断新方施旅旋族旗既日旦旧旨早旬昆昇昌明易昔星映春昧昨昭是昼時晋晩普景晴晶智暇暑暖暗暦暮暴曇曖曜曲更書曽替最月有服朔朗望朝期木未末本札朱朴机杉李杏材村杖束条来杯東松板析枕林枚果枝枠枯架柄柏染柔柱柳柴査栄栗校株核根格栽桂桃案桐桑桜梅條梨械棄棋棒棚棟森椅植検業極楽概構様槽標模権横樹橋機欄欠次欧欲欺歌歓止正武歩歪歯歳歴死殊残殖殴段殺殻殿母毎毒比毛氏民気水氷永汁求汗汚江池汰決沈沖沙没沢河沸油治沼沿況泉泊法泡波泣泥注泰泳洋洗洞津洲活派流浄浅浜浦浩浪浮浴海浸消涙涯液涼淡深淳混添清渇済渉渋減渡渥渦温測港湖湧湯湾湿満源準溜溝溢溶滅滑滝滞滴漁漂漏演漠漢漫漬潔潜潟潤潮潰澄澤激濁濃濡濯瀬火灯灰災炉炊炎炒炭点為烈無焦然焼煙照煮熊熟熱燃燕燥爆爪爵父爽片版牛牧物牲特犠犬犯状狂狙狩独狭狼猛猟猪猫献猿獄獣獲玄率玉王玲珍珠班現球理琴璧環瓦瓶甘生産用田由甲申男町画界畑留畜略番異畳疎疑疫疲疾病症痕痛痴瘍療癒癖発登白百的皆皇皮皿盆益盗盛盟監盤目直相盾省眉看県真眠眺眼着睡督睨瞬瞳矛矢知短石砂研砕砲破硝硫硬確磁磨礎示礼社祀祈祉祐祖祝神祥票祭禁禅禍福秀私秋科秒秘秩称移稀程税稚種稲稼稽稿穀穂積穏穴究空突窃窓窮窺立竜章童端競竹笑笛笠符第筆等筋筒答策箇算管箱箸節範篆篇築篠篤簡簿籍籠米粉粋粒粗粘粛粧精糖糧糸系紀約紅紋納紐純紗紙級紛素索紫細紹紺終組経結絞絡給統絵絶絹継続維綱網綴綺綾綿緊総緑緒線締編緩緯練縁縄縛縦縫縮績繁繊繋織繫繰缶罪置罰署羅羊美群義羽翁翌習翔翻翼老考者耐耕耗耳耶聖聞聡聲聴職肉肌肝股肢肥肩肪肯育肺胃胆背胎胞胡胴胸能脂脅脇脈脚脱脳腎腐腔腕腫腰腸腹腺膚膜膝膨臓臣臨自臭至致興舌舎舐舗舞舟航般船艦良色艶芝芦芯花芳芸芽苗苛若苦英茂茎茶草荒荘荷莉菅菊菌菓菜華菱萩落葉著葛葬蒸蓄蓋蓮蔵薄薩薬藍藝藤藩蘇蘭虎虐虚虫虹蛇蜂融血衆行術街衛衝衣表衰袋袖被裁裂装裏裕補裸製裾複褒襟襲西要覆覇見規視覗覚覧親観角解触言訂計訊討訓託記訟訪設許訳訴診証詐評詞詠試詩詰話該詳誇誉誌認誓誕誘語誠誤説読誰課調談請論諦諭諸諺諾謀謎謙講謝謡識譜警議譲護谷豆豊豚象豪貌貝貞負財貢貧貨販貫責貯貰貴買貸費貼貿賀賃資賊賛賞賠賢質賭購贅贈赤赦走起超越趣足距跡路跳践踊踏蹴躍身車軌軍軒軟転軸軽較載輔輝輩輪輸轄辛辞辰辱農辺辻込辿迎近返迫述迷追退送逃逆透途這通速造逢連逮週進逸遂遅遇遊運遍過道達違遠遣遥適遭遮選遺遼避還那邦邪邸郊郎郡部郭郵郷都配酒酔酢酬酷酸醒采釈里重野量金針釣鈍鈴鉄鉛鉢鉱銀銃銅銘銭鋭鋼錠錯録鍋鍛鍵鎌鎖鎮鏡鐘鑑長門閉開間関閣闇闘阪防阻阿附降限陛院陣除陥陰陳陶陸険陽隅隆隈隊階随隔隙際障隠隣隷雀雄雅集雇雑離難雨雪雰雲雷電需震霊霧露青静非面革靴韓音響頁頂頃項順須預頑領頭頰頷頻頼顆題額顎顔顕願類顧風飛食飯飲飼飽飾餅養館首香馬馳馴駄駅駆駈駐駒騎騒験騙驚骨高髙髪髭鬱鬼魂魅魔魚鮮鳥鳩鳴鶏鶴鷹鹿麗麦麻黄黒黙鼓鼻齢龍𠮟]
       
        ※ カードタイトル：「{_cardTitle}」
        ※ 説明文：「{_cardExplanation}」

        出力はJSON形式でお願いします。JSONのキーは以下の通りにしてください:
        - 頭脳: `intellect`
        - 頭脳攻撃文: `intellect_attack`
        - 運動: `athleticism`
        - 運動攻撃文: `athleticism_attack`
        - 運: `luck`
        - 運攻撃文: `luck_attack`
        - フレーバーテキスト: `flavor_text`

        例:
        ```json
        {{
          ""intellect"": 50,
          ""intellect_attack"": ""難しすぎて意味の分からないトーク"",
          ""athleticism"": 40,
          ""athleticism_attack"": ""比較的高速反復横跳び"",
          ""luck"": 10,
          ""luck_attack"": ""年始から小吉"",
          ""flavor_text"": ""鋭い洞察力で戦場を支配し、困難な状況も乗り越える賢者。""
        }}
        ```
        ";

    private Texture2D _tex = new Texture2D(2,2);

    public PromptFormatter()
    {
        _geminiCardGenerator = new GeminiCardGenerator();
    }

    // Start を UniTask に置き換え
    public async UniTask<GeminiCardGenerator.CardData> OrganizePrompt(string cardTitle, string cardExplanation, Texture2D tex)
    {
        _tex = tex;
        _cardTitle = cardTitle;
        _cardExplanation = cardExplanation;
        
        if (_tex == null)
        {
            Debug.LogError("画像が見つかりません。");
            return null;
        }

        try
        {
            // カードデータ生成を待機
            var card = await _geminiCardGenerator.GenerateCardDataAsync(_tex, _geminiPrompt);
            return card;
        }
        catch (Exception ex)
        {
            Debug.LogError("カード生成に失敗: " + ex.Message);
            return null;
        }
    }
}
